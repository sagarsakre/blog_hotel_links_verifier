name: Monitor Hotel Links Daily

on:
  workflow_dispatch:        # Allow manual trigger
  schedule:
    - cron: 15 10 * * *   # 3:45 PM IST (UTC 10:15)

jobs:
  verify-and-notify:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required for GitHub Pages deployment
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run verification scripts
        id: verify
        continue-on-error: true  # Don't stop workflow if verification finds issues
        env:
          AGODA_API_KEY: ${{ secrets.AGODA_API_KEY }}
          AGODA_SITE_ID: ${{ secrets.AGODA_SITE_ID }}
        run: |
          FAILED=0
          
          # Bali
          python verify_blog_links.py \
            --blog-url "https://sakrecubes.com/2022/10/bali-complete-travel-guide.html" \
            --output bali_hotels.csv \
            --destination "Bali" \
            --json-output bali_summary.json || FAILED=1
          
          # Varkala
          python verify_blog_links.py \
            --blog-url "https://sakrecubes.com/2024/12/varkala-complete-guide.html" \
            --output varkala_hotels.csv \
            --destination "Varkala" \
            --json-output varkala_summary.json || FAILED=1
          
          # Munnar
          python verify_blog_links.py \
            --blog-url "https://sakrecubes.com/2023/05/munnar-complete-travel-guide.html" \
            --output munnar_hotels.csv \
            --destination "Munnar" \
            --json-output munnar_summary.json || FAILED=1
          
          # Goa
          python verify_blog_links.py \
            --blog-url "https://sakrecubes.com/2022/12/goa-complete-travel-guide.html" \
            --output goa_hotels.csv \
            --destination "Goa" \
            --json-output goa_summary.json || FAILED=1
          
          # Singapore
          python verify_blog_links.py \
            --blog-url "https://sakrecubes.com/2023/12/singapore-complete-guide.html" \
            --output singapore_hotels.csv \
            --destination "Singapore" \
            --json-output singapore_summary.json || FAILED=1
          
          # Mysore
          python verify_blog_links.py \
            --blog-url "https://sakrecubes.com/2022/06/best-places-to-stay-in-mysore.html" \
            --output mysore_hotels.csv \
            --destination "Mysore" \
            --json-output mysore_summary.json || FAILED=1
          
          # Chikmagaluru
          python verify_blog_links.py \
            --blog-url "https://sakrecubes.com/2023/09/chikmagaluru.html" \
            --output chikmagaluru_hotels.csv \
            --destination "Chikmagaluru" \
            --json-output chikmagaluru_summary.json || FAILED=1
          
          # Udupi
          python verify_blog_links.py \
            --blog-url "https://sakrecubes.com/2023/10/udupi-complete-guide.html" \
            --output udupi_hotels.csv \
            --destination "Udupi" \
            --json-output udupi_summary.json || FAILED=1

          # Andaman
          python verify_blog_links.py \
            --blog-url "https://sakrecubes.com/2024/09/andaman-travel-guide.html" \
            --output andaman_hotels.csv \
            --destination "Andaman" \
            --json-output andaman_summary.json || FAILED=1
          
          # Kodaikanal
          python verify_blog_links.py \
            --blog-url "https://sakrecubes.com/2022/05/best-places-to-stay-in-kodaikanal.html" \
            --output kodaikanal_hotels.csv \
            --destination "Kodaikanal" \
            --json-output kodaikanal_summary.json || FAILED=1
            
          # Vietnam
          python verify_blog_links.py \
            --blog-url "https://sakrecubes.com/vietnam" \
            --output vietnam_hotels.csv \
            --destination "Vietnam" \
            --json-output kodaikanal_summary.json || FAILED=1

          # Pondicherry
          python verify_blog_links.py \
            --blog-url "https://sakrecubes.com/2023/09/pondicherry-complete-guide.html" \
            --output pondicherry_hotels.csv \
            --destination "Pondicherry" \
            --json-output pondicherry_summary.json || FAILED=1
            
          
          exit $FAILED
      
      - name: Upload verification reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hotel-verification-reports-${{ github.run_number }}
          path: |
            *_hotels.csv
            *_summary.json
          retention-days: 90
      
      - name: Send email notification
        if: steps.verify.outcome == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚ö†Ô∏è Agoda Hotel Links - Unavailable Properties Detected"
          to: sakrecubes@gmail.com
          from: GitHub Actions <noreply@github.com>
          body: |
            Hotel verification completed with issues detected.
            
            üìä View full dashboard: https://sagarsakre.github.io/blog_hotel_links_verifier/
            üîó Run details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            üì• Download all reports from the Actions artifacts.
          attachments: |
            *_hotels.csv
      
      - name: Generate HTML dashboard
        if: always()
        run: |
          python generate_dashboard.py \
            --input-dir . \
            --output docs/index.html
      
      - name: Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          commit_message: "Update dashboard: ${{ github.event.head_commit.message || 'Scheduled run' }}"
